# .github/workflows/ci.yml
name: CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        build_type: [Debug, Release]

    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Prepare Vulkan SDK
        uses: humbletim/setup-vulkan-sdk@v1.2.1
        with:
          vulkan-query-version: 1.4.304.0
          vulkan-components: Vulkan-Headers, Vulkan-Loader
          vulkan-use-cache: true
  
      - name: Cache UV
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ~/.cache/uv
          key: uv-${{ runner.os }}-${{ matrix.build_type }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
          restore-keys: |
            uv-${{ runner.os }}-${{ matrix.build_type }}-
            uv-${{ runner.os }}-

      - name: Cache Conan
        uses: actions/cache@v4
        with:
          path: |
            ~/.conan2
          key: conan2-${{ runner.os }}-${{ matrix.build_type }}-${{ hashFiles('**/conanfile.py', '**/conanfile.txt') }}
          restore-keys: |
            conan2-${{ runner.os }}-${{ matrix.build_type }}-
            conan2-${{ runner.os }}-

      - name: Install System Dependencies
        shell: bash
        run: |
          set -euo pipefail
          echo "Runner OS = $RUNNER_OS"
          if [[ "$RUNNER_OS" == "Linux" ]]; then
            sudo apt-get update
            pkgs=(
              build-essential pkg-config
              libx11-dev libx11-xcb-dev libxau-dev libxdmcp-dev
              libfontenc-dev libice-dev libsm-dev libxaw7-dev libxcomposite-dev
              libxdamage-dev libxkbfile-dev libxmu-dev libxmuu-dev libxpm-dev
              libxres-dev libxss-dev libxt-dev libxtst-dev libxv-dev libxxf86vm-dev
              libxcb1-dev libxcb-glx0-dev libxcb-render0-dev libxcb-render-util0-dev
              libxcb-xkb-dev libxcb-icccm4-dev libxcb-image0-dev libxcb-keysyms1-dev
              libxcb-randr0-dev libxcb-shape0-dev libxcb-sync-dev libxcb-xfixes0-dev
              libxcb-xinerama0-dev libxcb-dri3-dev libxcb-dri2-0-dev libxcb-present-dev
              libxcb-composite0-dev libxcb-ewmh-dev libxcb-res0-dev
              uuid-dev libgl1-mesa-dev libglvnd-dev libwayland-dev libxkbcommon-dev
              libxcursor-dev libxinerama-dev libxcb-cursor-dev libxcb-util-dev libxcb-util0-dev
            )
            sudo apt-get install -y --no-install-recommends "${pkgs[@]}"
          elif [[ "$RUNNER_OS" == "macOS" ]]; then
            echo "Using Xcode toolchain on macOS."
          else
            echo "Using MSVC toolchain on Windows."
          fi

      - name: Install Python Dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          python -m pip install uv
          uv sync --python 3.11 --dev

      - name: Conan Setup (README) on Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          uv run conan profile detect --force
          if [[ -d "conan_recipe" ]]; then
            cd conan_recipe
            uv run python build_conan_recipes.py -d . -b ${{ matrix.build_type }} -v
            cd ..
          else
            echo "No conan_recipe directory; skipping custom recipes."
          fi
          PBPT_VER="0.1.0-dev.${GITHUB_SHA::7}"
          uv run conan create external/pbpt \
            --name=pbpt \
            --version=${PBPT_VER} \
            -pr:h=external/pbpt/profiles/pbpt \
            -pr:b=external/pbpt/profiles/pbpt \
            -s build_type=${{ matrix.build_type }} \
            --build=missing
          uv run conan install . \
            -pr:h=profiles/rtr2 \
            -pr:b=profiles/rtr2 \
            -s build_type=${{ matrix.build_type }} \
            -s compiler.cppstd=23 \
            -o '&:with_pbpt=True' \
            -o '&:pbpt_version='"${PBPT_VER}" \
            --build=missing

      - name: Conan Setup (README) on Windows
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Set-ExecutionPolicy -Scope Process Bypass -Force
          uv run conan profile detect --force
          if (Test-Path "conan_recipe") {
            Push-Location conan_recipe
            uv run python build_conan_recipes.py -d . -b ${{ matrix.build_type }} -v
            Pop-Location
          } else {
            Write-Host "No conan_recipe directory; skipping custom recipes."
          }
          $pbptVer = "0.1.0-dev.$($env:GITHUB_SHA.Substring(0,7))"
          uv run conan create external/pbpt `
            --name=pbpt `
            --version=$pbptVer `
            -pr:h=external/pbpt/profiles/pbpt `
            -pr:b=external/pbpt/profiles/pbpt `
            -s build_type=${{ matrix.build_type }} `
            --build=missing
          uv run conan install . `
            -pr:h=profiles/rtr2 `
            -pr:b=profiles/rtr2 `
            -s build_type=${{ matrix.build_type }} `
            -s compiler.cppstd=23 `
            -o '&:with_pbpt=True' `
            -o "&:pbpt_version=$pbptVer" `
            --build=missing

      - name: Configure and Build (CMake Presets) on Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail
          build_type="${{ matrix.build_type }}"
          preset="conan-$(echo "$build_type" | tr '[:upper:]' '[:lower:]')"
          source "build/${build_type}/generators/conanbuild.sh"
          set +u
          source "build/${build_type}/generators/conanrun.sh"
          set -u
          cmake --list-presets
          cmake --preset "$preset"
          cmake --build --preset "$preset"

      - name: Configure and Build (CMake Presets) on Windows
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          @echo on
          set BUILD_TYPE=${{ matrix.build_type }}
          if /I "%BUILD_TYPE%"=="Debug" (set PRESET=conan-debug) else (set PRESET=conan-release)
          call "build\%BUILD_TYPE%\generators\conanbuild.bat"
          call "build\%BUILD_TYPE%\generators\conanrun.bat"
          cmake --list-presets
          cmake --preset %PRESET%
          cmake --build --preset %PRESET%

      - name: Test (${{ matrix.build_type }}) on Linux/macOS
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -e
          source build/${{ matrix.build_type }}/generators/conanrun.sh
          ctest --test-dir build/${{ matrix.build_type }} -C ${{ matrix.build_type }} --output-on-failure

      - name: Test (${{ matrix.build_type }}) on Windows
        if: runner.os == 'Windows'
        shell: cmd
        run: |
          call "build\${{ matrix.build_type }}\generators\conanrun.bat"
          ctest --test-dir "build\${{ matrix.build_type }}" --output-on-failure
